<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python Editor (Pyodide + CodeMirror)</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background: #1e1e1e;
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    #version {
      position: absolute;
      top: 5px;
      left: 10px;
      font-size: 12px;
      color: #aaa;
    }
    #editor {
      flex: 1;
      border-bottom: 2px solid #444;
    }
    #buttons {
      display: flex;
      gap: 10px;
      padding: 8px;
      background: #222;
      border-bottom: 2px solid #444;
    }
    button {
      background: #444;
      border: none;
      color: white;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 3px;
    }
    button:hover {
      background: #666;
    }
    #output {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #111;
      white-space: pre-wrap;
    }
    .stdout { color: #ddd; }
    .stderr { color: #f55; }
    .status { color: #5af; }
  </style>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
  <div id="version">Version 1.0</div>
  <div id="editor"></div>
  <div id="buttons">
    <button id="runBtn">‚ñ∂ Run (Ctrl+Enter)</button>
    <button id="copyBtn">üìã Copy Output</button>
    <button id="pasteBtn">üì• Paste into Editor</button>
  </div>
  <div id="output"></div>

  <script>
    // Setup CodeMirror editor
    const editor = CodeMirror(document.getElementById("editor"), {
      mode: "python",
      theme: "default",
      lineNumbers: true,
      autoCloseBrackets: true,
      value: "print('Hello from Python!')\n"
    });

    const runBtn = document.getElementById("runBtn");
    const copyBtn = document.getElementById("copyBtn");
    const pasteBtn = document.getElementById("pasteBtn");
    const outputEl = document.getElementById("output");

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"]/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])
      );
    }

    let pyodideReady = false;
    let pyodideInstance = null;

    (async () => {
      outputEl.innerHTML = "<span class='status'>‚è≥ Loading Pyodide...</span>";
      pyodideInstance = await loadPyodide();
      pyodideReady = true;
      outputEl.innerHTML = "<span class='status'>‚úÖ Pyodide loaded! Press Run.</span>";
    })();

    async function runCode() {
      if (!pyodideReady) {
        outputEl.innerHTML = "<span class='stderr'>Pyodide not ready yet.</span>";
        return;
      }

      outputEl.innerHTML = "<span class='status'>‚ñ∂ Running...</span>\n";

      try {
        const code = editor.getValue();
        const wrapped = [
          "import sys, io, traceback",
          "_buf = io.StringIO()",
          "_old_out, _old_err = sys.stdout, sys.stderr",
          "sys.stdout = _buf",
          "sys.stderr = _buf",
          "try:"
        ].concat(
          code.split("\n").map(line => "    " + line)
        ).concat([
          "except Exception:",
          "    traceback.print_exc()",
          "finally:",
          "    sys.stdout = _old_out",
          "    sys.stderr = _old_err",
          "_buf.getvalue()"
        ]).join("\n");

        const result = await pyodideInstance.runPythonAsync(wrapped);
        const out = result ? String(result) : "";

        if (!out.trim()) {
          outputEl.innerHTML = "<span class='status'>(no output)</span>";
          return;
        }

        const lines = out.split(/\r?\n/);
        const formatted = lines.map(l => {
          const esc = escapeHtml(l);
          if (/traceback/i.test(l) || /error/i.test(l)) {
            return `<div class="stderr">${esc}</div>`;
          } else {
            return `<div class="stdout">${esc}</div>`;
          }
        }).join("");
        outputEl.innerHTML = formatted;

      } catch (err) {
        outputEl.innerHTML = `<span class="stderr">Runtime error: ${escapeHtml(String(err))}</span>`;
      }
    }

    // Run button
    runBtn.onclick = runCode;

    // Copy button
    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(outputEl.innerText);
        copyBtn.innerText = "‚úÖ Copied!";
        setTimeout(() => copyBtn.innerText = "üìã Copy Output", 1500);
      } catch (err) {
        alert("Clipboard copy failed.");
      }
    };

    // Paste button
    pasteBtn.onclick = async () => {
      try {
        const text = await navigator.clipboard.readText();
        editor.replaceRange(text, editor.getCursor());
      } catch (err) {
        alert("Clipboard paste failed.");
      }
    };

    // Keyboard shortcut (Ctrl+Enter / Cmd+Enter)
    editor.addKeyMap({
      "Ctrl-Enter": () => runBtn.click(),
      "Cmd-Enter": () => runBtn.click()
    });
  </script>
</body>
</html>
